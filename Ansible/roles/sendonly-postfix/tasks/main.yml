- name: Instalamos los certificados de ejemplo
  ansible.builtin.apt:
    name:
      - ssl-cert
    state: present

- name: Instalar postfix
  ansible.builtin.apt:
    name:
      - postfix
    state: present

- name: Configurar el nombre de dominio
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^mydomain ="
    line: 'mydomain = {{ MAIL_DOMAIN }}'
  notify: restart_postfix

- name: Configurar el nombre del servidor
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^myhostname ="
    line: 'myhostname = {{ MAIL_NAME }}.$mydomain'
  notify: restart_postfix

- name: Configurar el apartado "From" del correo electronico
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^myorigin ="
    line: 'myorigin = $mydomain'
  notify: restart_postfix

- name: Configurar las interfaces de escucha
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^inet_interfaces ="
    line: 'inet_interfaces = all'
  notify: restart_postfix

- name: Configurar los protocolos de escucha
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^inet_protocols ="
    line: 'inet_protocols = all'
  notify: restart_postfix

- name: Habilitar las bitacoras de postfix
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^maillog_file ="
    line: 'maillog_file = /var/log/mail.log'
  notify: restart_postfix

- name: Configuramos la rotacion de las bitacoras de postfix
  ansible.builtin.template:
    src: postfix.j2
    dest: /etc/logrotate.d/postfix
  notify: restart_postfix

- name: Instalar las librerias de autenticacion de postfix
  ansible.builtin.apt:
    name:
      - libsasl2-modules
    state: present

- name: Copiar la base de datos de la configuracion para gmail
  ansible.builtin.copy:
    src: "sasl_passwd.db"
    dest: /etc/postfix/sasl/sasl_passwd.db
    owner: root
    group: root
    mode: '0600'
  notify: restart_postfix

- name: Configurar el servidor de correo de envio
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^relayhost ="
    line: 'relayhost = [smtp.gmail.com]:587'
  notify: restart_postfix

- name: Habilitar la autenticacion conmo cliente en postfix
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^smtp_sasl_auth_enable ="
    line: 'smtp_sasl_auth_enable = yes'
  notify: restart_postfix

- name: Desabilitar la autenticacion como cliente anonimo en postfix
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^smtp_sasl_security_options ="
    line: 'smtp_sasl_security_options = noanonymous'
  notify: restart_postfix

- name: Configurar el usuario y la contrase√±a del servidor de correo de envio
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^smtp_sasl_password_maps ="
    line: 'smtp_sasl_password_maps = hash:/etc/postfix/sasl/sasl_passwd'
  notify: restart_postfix

- name: Habilitar el uso de TLS como cliente en postfix
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^smtp_tls_security_level ="
    line: 'smtp_tls_security_level = encrypt'
  notify: restart_postfix

- name: Configurar el certificado TLS ha emplear como cliente en postfix
  ansible.builtin.lineinfile:
    dest: /etc/postfix/main.cf
    regexp: "^smtp_tls_CAfile ="
    line: 'smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt'
  notify: restart_postfix

- name: Instalar las herramientas de consola para el manejo de correos
  ansible.builtin.apt:
    name:
      - mailutils
    state: present
